#!/usr/bin/env node
/**
 * Build script to generate service-worker.js with automatic cache versioning
 * 
 * This script reads the service worker template and injects the current git
 * commit hash as the cache version. This ensures the cache is invalidated
 * whenever new code is deployed.
 * 
 * Usage:
 *   node scripts/build-service-worker.js
 *   npm run build:sw
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Paths
const TEMPLATE_PATH = path.join(__dirname, '../core/public/service-worker.template.js');
const OUTPUT_PATH = path.join(__dirname, '../core/public/service-worker.js');

/**
 * Get the current git commit hash (short version)
 * Falls back to timestamp if git is not available
 */
function getVersion() {
    try {
        const gitHash = execSync('git rev-parse --short HEAD', { 
            encoding: 'utf8',
            stdio: ['pipe', 'pipe', 'pipe'] // Suppress stderr
        }).trim();
        const timestamp = Date.now();
        return `${gitHash}-${timestamp}`;
    } catch (error) {
        console.warn('Warning: Could not get git hash (git may not be installed or not a git repository). Falling back to timestamp-only version.');
        return `build-${Date.now()}`;
    }
}

/**
 * Get the current git branch name
 */
function getBranch() {
    try {
        return execSync('git rev-parse --abbrev-ref HEAD', { 
            encoding: 'utf8',
            stdio: ['pipe', 'pipe', 'pipe'] // Suppress stderr
        }).trim();
    } catch (error) {
        return 'unknown';
    }
}

/**
 * Build the service worker file
 */
function buildServiceWorker() {
    console.log('Building service worker with automatic cache versioning...');
    
    // Check if template exists
    if (!fs.existsSync(TEMPLATE_PATH)) {
        console.error(`Error: Template file not found at ${TEMPLATE_PATH}`);
        console.log('Creating template from existing service-worker.js...');
        
        // If no template exists but service-worker.js does, create template from it
        if (fs.existsSync(OUTPUT_PATH)) {
            try {
                const existing = fs.readFileSync(OUTPUT_PATH, 'utf8');
                // Replace the hardcoded version with placeholder
                const template = existing.replace(
                    /const CACHE_NAME = ['"]ai-questions-cache-[^'"]+['"]/,
                    "const CACHE_NAME = 'ai-questions-cache-{{VERSION}}'"
                );
                fs.writeFileSync(TEMPLATE_PATH, template);
                console.log('Template created from existing service-worker.js');
            } catch (error) {
                console.error('Error creating template:', error.message);
                if (error.code === 'EACCES') {
                    console.error('Permission denied. Please check file permissions.');
                }
                process.exit(1);
            }
        } else {
            console.error('Error: No service-worker.js found to create template from');
            process.exit(1);
        }
    }
    
    // Read template
    let template;
    try {
        template = fs.readFileSync(TEMPLATE_PATH, 'utf8');
    } catch (error) {
        console.error('Error reading template file:', error.message);
        if (error.code === 'EACCES') {
            console.error('Permission denied. Please check file permissions.');
        }
        process.exit(1);
    }
    
    // Get version info
    const version = getVersion();
    const branch = getBranch();
    const buildDate = new Date().toISOString();
    
    // Replace placeholders
    let output = template
        .replace(/\{\{VERSION\}\}/g, version)
        .replace(/\{\{BRANCH\}\}/g, branch)
        .replace(/\{\{BUILD_DATE\}\}/g, buildDate);
    
    // Add build info comment at the top
    const buildInfo = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
 * 
 * This file is generated by scripts/build-service-worker.js
 * To make changes, edit service-worker.template.js instead.
 * 
 * Build Info:
 *   Version: ${version}
 *   Branch: ${branch}
 *   Built: ${buildDate}
 */

`;
    
    output = buildInfo + output;
    
    // Write output with error handling
    try {
        fs.writeFileSync(OUTPUT_PATH, output);
        console.log(`Service worker built successfully!`);
        console.log(`  Version: ${version}`);
        console.log(`  Branch: ${branch}`);
        console.log(`  Output: ${OUTPUT_PATH}`);
    } catch (error) {
        console.error('Error writing output file:', error.message);
        if (error.code === 'EACCES') {
            console.error('Permission denied. Please check file permissions.');
        } else if (error.code === 'ENOSPC') {
            console.error('No space left on device.');
        }
        process.exit(1);
    }
}

// Run the build
buildServiceWorker();
