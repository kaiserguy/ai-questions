name: Post-Deployment Validation

on:
  workflow_dispatch:  # Allow manual triggering
    inputs:
      deployment_url:
        description: 'Deployment URL to validate'
        required: false
        default: 'https://peaceful-sierra-40313-4a09d237c70e.herokuapp.com'

jobs:
  validate-production:
    runs-on: ubuntu-latest
    
    env:
      DEPLOYMENT_URL: ${{ 'https://peaceful-sierra-40313-4a09d237c70e.herokuapp.com' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
    
    - name: Wait for deployment
      run: |
        echo "Waiting a minute for deployment to stabilize..."
        sleep 60  # Wait for Heroku to fully deploy and stabilize
        
    - name: Health Check
      run: ./tests/validation/production-health-check.sh
        
    - name: Critical Path Validation
      run: ./tests/validation/production-critical-paths.sh
        
    - name: API Endpoint Validation
      run: ./tests/validation/production-api-validation.sh
        
    - name: Offline Functionality Deep Check
      run: ./tests/validation/production-offline-check.sh
        
    - name: JavaScript Error Detection
      run: ./tests/validation/production-js-error-check.sh
        
    - name: Generate production validation report
      if: always()
      run: |
        echo "## ðŸš€ Post-Deployment Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Production Validations:" >> $GITHUB_STEP_SUMMARY
        echo "- Health check and response time" >> $GITHUB_STEP_SUMMARY
        echo "- Critical user path validation" >> $GITHUB_STEP_SUMMARY
        echo "- API endpoint accessibility" >> $GITHUB_STEP_SUMMARY
        echo "- Offline functionality verification" >> $GITHUB_STEP_SUMMARY
        echo "- JavaScript error detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Production Status: Validated** âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Live URL**: $DEPLOYMENT_URL" >> $GITHUB_STEP_SUMMARY